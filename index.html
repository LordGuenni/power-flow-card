<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Animated Smart Grid Diagram</title>
    <style>
      .anim-line {
        stroke-dasharray: 20 15;
        animation:
          dash-move 6s linear infinite,
          pulse 5s ease-in-out infinite alternate;
        filter: url(#glow);
        stroke-width: 5px;
        --dash-dir: -200; /* Default direction (forward) */
      }

      .reverse-flow {
        --dash-dir: 200; /* Reverse direction */
      }

      @keyframes dash-move {
        to {
          stroke-dashoffset: var(--dash-dir);
        }
      }

      /* Color definitions */
      .solar {
        stroke: gold !important;
      }
      .grid-import {
        stroke: dodgerblue !important;
      }
      .grid-export {
        stroke: limegreen !important;
      }
      .ev {
        stroke: deepskyblue !important;
      }
      .bat-charge {
        stroke: cornflowerblue !important;
      }

      @keyframes pulse {
        0% {
          stroke-opacity: 0.6;
          filter: drop-shadow(0 0 0px rgba(255, 255, 255, 0));
        }
        25% {
          stroke-opacity: 0.8;
          filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.2));
        }
        50% {
          stroke-opacity: 1;
          filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.3));
        }
        75% {
          stroke-opacity: 0.8;
          filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.2));
        }
        100% {
          stroke-opacity: 0.6;
          filter: drop-shadow(0 0 0px rgba(255, 255, 255, 0));
        }
      }

      /* Styling for the background layer */
      #svg-container-bg svg {
        opacity: 0.5;
        pointer-events: none;
      }

      body {
        background-color: #333;
      }

      /* Descriptor Labels */
      .descriptor {
        position: absolute;
        font-size: 12px;
        font-weight: 500;
        color: #999;
        pointer-events: none;
        text-align: center;
        white-space: nowrap;
      }

      .descriptor-solar {
        top: 15%;
        left: 20%;
        transform: translateX(-50%);
      }

      .descriptor-grid {
        top: 50%;
        right: 8%;
        transform: translateY(-50%);
      }

      .descriptor-battery {
        bottom: 25%;
        left: 20%;
        transform: translateX(-50%);
      }

      .descriptor-ev {
        bottom: 15%;
        left: 50%;
        transform: translateX(-50%);
      }

      .descriptor-home {
        top: 50%;
        left: 8%;
        transform: translateY(-50%);
      }
    </style>
  </head>
  <body>
    <div id="svg-overlay" style="position: relative; width: 750px; height: 300px; pointer-events: none">
      <div
        id="svg-container-bg"
        style="position: absolute; inset: 0; display: flex; justify-content: center; align-items: center"
      ></div>
      <div
        id="svg-container-solar"
        style="position: absolute; inset: 0; display: flex; justify-content: center; align-items: center"
      ></div>
      <div
        id="svg-container-battery"
        style="position: absolute; inset: 0; display: flex; justify-content: center; align-items: center"
      ></div>
      <div
        id="svg-container-ev"
        style="position: absolute; inset: 0; display: flex; justify-content: center; align-items: center"
      ></div>
      <div
        id="svg-container"
        style="position: absolute; inset: 0; display: flex; justify-content: center; align-items: center"
      ></div>
      <div
        id="svg-container-out"
        style="position: absolute; inset: 0; display: flex; justify-content: center; align-items: center"
      ></div>
      
      <!-- Descriptor Labels -->
      <div class="descriptor descriptor-solar">Solarzellen</div>
      <div class="descriptor descriptor-grid">Netz</div>
      <div class="descriptor descriptor-battery">Battery</div>
      <div class="descriptor descriptor-ev">EV</div>
      <div class="descriptor descriptor-home">Home</div>
    </div>

    <script>
      (function () {
        // ðŸ’¡ CORRECTED PATHS
        const primaryPath = './assets/grid_line.svg';
        const outPath = './assets/grid_out.svg';
        const solarPath = './assets/solar_line.svg';
        const batteryPath = './assets/home_battery.svg';
        const evPath = './assets/ev_line.svg';
        const bgPath = './assets/home.svg';

        const containerBG = document.getElementById('svg-container-bg');
        const containerSolar = document.getElementById('svg-container-solar');
        const containerBattery = document.getElementById('svg-container-battery');
        const containerEV = document.getElementById('svg-container-ev');
        const containerA = document.getElementById('svg-container');
        const containerB = document.getElementById('svg-container-out');

        function ensureGlow(svgEl) {
          if (!svgEl.querySelector('#glow')) {
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            defs.innerHTML = `
                        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur stdDeviation="2.5" result="blur"/>
                            <feMerge>
                                <feMergeNode in="blur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>`;
            svgEl.insertBefore(defs, svgEl.firstChild);
          }
        }

        function processBGSVGString(text, container) {
          container.innerHTML = text;
          const svgEl = container.querySelector('svg');
          if (!svgEl) return (container.innerHTML = '<p style="color:#f99">No &lt;svg&gt; found</p>');
        }

        function processSVGString(text, container, lineType) {
          container.innerHTML = text;
          const svgEl = container.querySelector('svg');
          if (!svgEl) return (container.innerHTML = '<p style="color:#f99">No &lt;svg&gt; found</p>');
          ensureGlow(svgEl);

          let colorMap = {
            solar: 'gold',
            'grid-import': 'dodgerblue',
            'grid-export': 'limegreen',
            'bat-charge': 'cornflowerblue',
            ev: 'deepskyblue',
          };

          const desiredClass = lineType || 'grid-import';
          const desiredColor = colorMap[desiredClass] || 'red';

          svgEl.querySelectorAll('path, circle, rect, line, polyline, polygon').forEach((el) => {
            if (el.nodeName === 'rect') {
              return;
            }

            el.classList.add('anim-line');

            if (lineType === 'grid-import') {
              el.classList.add('reverse-flow');
            }

            if (lineType === 'solar') {
              el.classList.add('reverse-flow');
            }

            el.classList.add(desiredClass);
            el.setAttribute('stroke', desiredColor);
            el.style.setProperty('stroke', desiredColor, 'important');

            if (el.hasAttribute('stroke')) el.removeAttribute('stroke');
          });
        }

        function loadSVG(path, container, lineType, isBackground = false) {
          return fetch(path)
            .then((r) => {
              if (!r.ok) throw new Error('SVG load failed: ' + r.status);
              return r.text();
            })
            .then((text) => {
              if (isBackground) {
                processBGSVGString(text, container);
              } else {
                processSVGString(text, container, lineType);
              }
            })
            .catch((err) => {
              console.error(err);
              container.innerHTML = `<p style="color:#f99; text-align:center;">Failed to load SVG: ${path}</p>`;
            });
        }

        // Load Background
        loadSVG(bgPath, containerBG, null, true);

        // Load Animated Lines
        loadSVG(solarPath, containerSolar, 'solar');
        loadSVG(batteryPath, containerBattery, 'bat-charge');
        loadSVG(evPath, containerEV, 'ev');
        loadSVG(primaryPath, containerA, 'grid-import');
        loadSVG(outPath, containerB, 'grid-export');
      })();
    </script>
  </body>
</html>
